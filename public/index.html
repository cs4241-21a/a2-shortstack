<!doctype html>
<html lang="en">

<head>
  <link rel = "stylesheet" href ="css/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto Sans">
  <title>CS4241 Assignment 2</title>
  <meta charset="utf-8">
</head>

<body>
  <div class = "flex-container">
    <div id = "titles">
    <h1>The Lame Calculator</h1>
    <h2>Somehow still a better deal than TI calculators™</h2>
    <h3>Collaborative Computing, done wrong©</h3>
    </div>
    <p>Enter a valid number in the boxes along with an operator, then press compute to perform the designed operation on those numbers. Results are sorted with most recent appearing at the top for convenience. </p>
    <p id = "warning">WARNING: DO NOT ATTEMPT TO COMMUNICATE WITH CALCULATOR IN BINARY VIA COMPUTATION. IGNORE ALL SECRET RESPONSES.</p>
    <div class = "flex-container" id = "computeform">
      <form>
        <input type="number" class="fvalue" id="value1" value="">
        <input type="text" class ="foperator" id ="operator" value ="">
        <input type="number" class="fvalue" id="value2" value="">
        <button id ="compute">compute</button>
      </form>
    </div>
    <div id = "notesandconvert" class = "flex-container">
      <div>
        <p>Notes:</p>
        <ul>
          <li>Supported operations are +, -, *, /, and ^.</li>
          <li>Whitespace is supported within numbers, but NOT by the binary parser.</li>
          <li>01110100 01110010 01111001 00100000 01110100 01100101 01110011 01110100</li>
        </ul>
      </div>
      <div>
        <p>The "convert" button converts text to the decimal equivalent of the text's binary representation. Use this to avoid accidentally communicating with the calculator by having your computation result be the decimal equivalent of some binary phrase.</p>
        <input type = "text" id ="bintext">
        <input id="bintextconv"/>
        <button id = "convert">convert</button>
        <p id = "convertedtext"></p>
      </div>
    </div>
    <div class = "flex-container" id ="tablecontainer">
      <table id = "table">
        <colgroup>
          <col span = "1" style = "width: 30%">
          <col span = "1" style = "width: 20%">
          <col span = "1" style = "width: 20%">
          <col span = "1" style = "width: 5%">
          <col span = "1" style = "width: 25%">
        </colgroup>
        <tbody>
        <tr>
          <th>Computation Number</th>
          <th>Var 1</th>
          <th>Var 2</th>
          <th>Op.</th>
          <th>Result</th>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</body>
<script>
  
  const submit = function (e) {
    // prevent default form action from being carried out
    e.preventDefault()

    let val1 = document.getElementById("value1").value;
    let val2 = document.getElementById("value2").value;
    const op = document.getElementById("operator").value;
    val1 = val1.replace(/\s+/g, ''); //remove all whitespace
    val2 = val2.replace(/\s+/g, '');
    if (isNaN(val1) || isNaN(val2) || val1 === "" || val2 ===""){
      alert("Must input numbers");
    }
    else if (op.match(/^[-+/^*]/) === null){
      alert("Must input valid operator (+, -, *, /, ^)");
    }
    else{
      json = {x: val1, y: val2, o: op},
      body = JSON.stringify(json)
      fetch('/submit', {
      method: 'POST',
      body
    })
      .then(function (response) {
          return response.json();
      }).then(function(data){
        addRows(data);
      })
    }

    return false
  }

  const convert = function(){
    let input = document.getElementById("bintext").value.toLowerCase();
    //SET INPUT TO LOWERCASE
    let output = "";
    for (var i = 0; i < input.length; i++) {
      output += input[i].charCodeAt(0).toString(2) + " ";
    }
    //console.log(output); //number in binary, with spaces
    //console.log(parseInt(output.split(" ").join(""), 2)); //actual number
    //console.log(parseInt(output.split(" ").join(""), 2).toString(2)); //number in binary

    document.getElementById("bintextconv").value = parseInt(output.split(" ").join(""), 2);
  }

  window.onload = function () {
    const button = document.getElementById("compute"); 
    button.onclick = submit

    document.getElementById("convert").onclick = convert;
    
    body = ""
    fetch('/load', {
      method: 'POST',
      body
    })
      .then(function (response) {
          return response.json();
      }).then(function(data){
        addRows(data);
      })
    //I can do a POST with a different url /load
    //NEED TO LOAD THE WHOLE TABLE HERE
  }

  function addRows(response){
    r = response;
    //r = JSON.parse(response);
    table = document.getElementById("table");

    rlen = table.rows.length
    for (i = 1; i < rlen; i++){
      try {
        table.deleteRow(rlen-i);
      }
      catch(e){
        alert(e);
        console.log("failed to delete row");
      }
    }

    for (i = 0; i < r.length; i++){
      let row = table.insertRow(1);
      
      let cell1 = row.insertCell();
      let el = document.createElement("td");
      el.style = "border: none";
      el.innerText = r[i].name;
      cell1.appendChild(el);

      let cell2 = row.insertCell();
      let el2 = document.createElement("td");
      el2.style = "border: none";
      el2.innerText = r[i].x;
      cell2.appendChild(el2);

      let cell3 = row.insertCell();
      let el3 = document.createElement("td");
      el3.style = "border: none";
      el3.innerText = r[i].y;
      cell3.appendChild(el3);

      let cell4 = row.insertCell();
      let el4 = document.createElement("td");
      el4.style = "border: none";
      el4.innerText = r[i].o;
      cell4.appendChild(el4);

      let cell5 = row.insertCell();
      let el5 = document.createElement("td");
      el5.style = "border: none";
      el5.innerText = r[i].result;
      cell5.appendChild(el5);
    }
  }

</script>

</html>